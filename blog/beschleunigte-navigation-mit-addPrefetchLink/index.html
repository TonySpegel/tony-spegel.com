<!DOCTYPE html>

<!doctype html>
<html lang="de">
  
  <head>
  
  








<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beschleunigte Navigation mit Link prefetching</title>
<meta name="description" content="Homepage &amp; Blog zu moderner Web-Entwicklung: Web-Apps, Angular, TypeScript, Web Components, Shopify &amp; Barrierefreiheit">
<meta name="generator" content="Eleventy v2.0.1">
<meta name="theme-color" content="#d5d5ff" media="(prefers-color-scheme: light)">
<meta property="og:title" content="Beschleunigte Navigation mit Link prefetching">
<meta property="og:description" content="Homepage &amp; Blog zu moderner Web-Entwicklung: Web-Apps, Angular, TypeScript, Web Components, Shopify &amp; Barrierefreiheit">

<meta name="version" content="6.0.1">


  

  <style>
    
      
    
  </style>


  <script>
  // Read theme preference from localStorage
  const themePreference = localStorage.getItem('theme-preference');
  // Set theme if one is present in localStorage
  if (themePreference !== null) {
    document
      .querySelector('html')
      .setAttribute('theme-preference', themePreference);
  }
</script>


  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Tony Spegel">
  <link rel="alternate" href="/feed/feed.json" type="application/json" title="Tony Spegel">

  
  
  <link rel="icon" href="/favicon.svg">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" >
</head>

  <body>
    
<theme-switch>
  <h2 slot="heading">Theme Auswahl</h2>
  <span slot="sub-heading">Wähle ein Theme für die Website</span>
  <a href="datenschutzerklaerung/#auswertung-des-verhaltens-von-besucherinnen-und-besuchern-cookies"
    id="read-more"
    slot="read-more"
    target="_blank"
    title="Was wird gespeichert?"
  >
    ?
  </a>
  <span slot="close-caption">Schließen</span>
</theme-switch>

    <header id="site-header">
  <nav aria-label="Hauptnavigation">
    
      <a class="logo" href="/" title="Zur Startseite">
        <img src="/tsp_icon.svg" alt="Tony Spegel Logo">
      </a>
    

    <ul class="header-links">
      
      <li class="dropdown">
        <button type="button"id="dropdown__title">
          Inhalt
          <span class="material-symbols-outlined" aria-hidden="true">toc</span>
        </button>

        <div class="dropdown__toc" id="drop-down-container">
          <toc-observer observeParent>
            <div slot="toc">
              <nav class="toc">
                <ol>
                    
                    <li><a href="#anforderungen">Anforderungen</a>
            		</li>

                    <li><a href="#die-richtigen-links-selektieren">Die richtigen Links selektieren</a>
            		</li>

                    <li><a href="#links-prefetchen">Links prefetchen</a>
            
                <ol>
                    
                    <li><a href="#datensparmodus-und-langsame-verbindungen-beruecksichtigen">Datensparmodus und langsame Verbindungen berücksichtigen</a>
            		</li>

                    <li><a href="#links-prefetchen-1">Links prefetchen</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#eine-interaktion-pro-link">Eine Interaktion pro Link</a>
            		</li>

                    <li><a href="#fazit">Fazit</a>
            		</li>
                </ol>
            </nav>
            </div>
          </toc-observer>
        </div>
      </li>
      
      <li>
        <button id="btn-theme-selection" title="Farbschema auswählen"></button>
      </li>
    </ul>
  </nav>
</header>

    <div class="glass"></div>
    <div class="bubble"></div>
    <div class="bubble-2"></div>
    <div class="main-wrapper post">
      <main>
        <div id="sentinel-element"></div>
        <header>
          <time class="article-date" datetime="2021-10-04">
            04.10.2021
          </time>
          <h1>Beschleunigte Navigation mit Link prefetching</h1>
          <ul class="post-tags">
            
              
              <li>
                
  
      <a href="/tags/javascript/" class="post-tag">#JavaScript</a>
  

              </li>
            
              
              <li>
                
  
      <a href="/tags/typescript/" class="post-tag">#TypeScript</a>
  

              </li>
            
              
              <li>
                
  
      <a href="/tags/performance/" class="post-tag">#Performance</a>
  

              </li>
            
          </ul>
        </header>

        <p>Prefetching beschreibt einen Prozess, welcher eventuell benötigte Inhalte vorlädt, um diese schneller aufrufen zu können. Das kann beispielsweise so aussehen: <code>&lt;link rel=&quot;prefetch&quot; href=&quot;/img/catsarecute.jpg&quot; /&gt;</code>. Browser werden diese Ressource dann herunterladen und zwischenspeichern (allerdings nur im <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ#how_is_browser_idle_time_determined" target="_blank" rel="noopener noreferrer">Idle</a>).</p>
<p>Alle Links einer Seite für das Prefetching hinzuzufügen ist natürlich wenig sinnvoll.<br>
Um das zu optimieren ist mein Ansatz, Links nur auf eine Interaktion hin zu prefetchen - also beispielsweise das Zeigen mit der Maus oder das Fokussieren mit einer Tastatur. Inspiration habe ich mir hierbei durch das von Google entwickelte <a href="https://getquick.link/" target="_blank" rel="noopener noreferrer">Quicklink</a> geholt. Der entscheidende Unterschied zu meiner Lösung ist, dass Quicklink alle Links im sichtbaren Bereichen vorlädt (wenn der Browser im Idle ist) und nicht durch eine Interaktion.</p>
<p>Links zu meiner Lösung <em>addPrefetchLink</em>:</p>
<ul>
<li><a href="https://codepen.io/TonySpegel/full/PojrqZb" target="_blank" rel="noopener noreferrer">Demo (Codepen)</a></li>
<li><a href="https://www.npmjs.com/package/add-prefetch-link" target="_blank" rel="noopener noreferrer">NPM</a></li>
<li><a href="https://github.com/TonySpegel/addPrefetchLink" target="_blank" rel="noopener noreferrer">GitHub</a></li>
</ul>
<section>
<h2 id="anforderungen"><a class="header-anchor" href="#anforderungen">Anforderungen</a></h2>
<ul>
<li>Links welche ein <code>mailto:</code> oder <code>tel:</code> enthalten, sollen nicht prefetched werden</li>
<li>Ist ein Datensparmodus aktiv oder ist die Verbindung zu langsam, sollen keine Links prefetched werden</li>
<li>Pro Link darf nur eine Interaktion das Prefetching auslösen</li>
</ul>
</section>
<section>
<h2 id="die-richtigen-links-selektieren"><a class="header-anchor" href="#die-richtigen-links-selektieren">Die richtigen Links selektieren</a></h2>
<p>Da es bei E-Mail Links, Telefonnummern oder Linkf auf aktuellen Seite keinen Sinn ergibt, diese zu prefetchen, sollten diese ignoriert werden. Ich nutze dazu einfach einen CSS Selektor welche alle Links selektiert, deren href-Attribut nicht mit dem entsprechenden Prefix beginnt:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">/* JavaScript */</span><br><span class="token keyword">const</span> links <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><br>  <span class="token string">'a:not([href^="mailto:"]):not([href^="tel:"]):not([href^="#"])'</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>document<br>  <span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>links<span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">link</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Man könnte natürlich auch ein Array erstellen und dieses entsprechend filtern.</p>
</section>
<section>
<h2 id="links-prefetchen"><a class="header-anchor" href="#links-prefetchen">Links prefetchen</a></h2>
<p>Als erstes definiere ich eine Funktion welche Links zum <code>&lt;head&gt;</code> hinzufügen soll, als einzigen Parameter ein Event erwartet und als Rückgabetyp zunächst <code>void</code> definiert:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">/* TypeScript */</span><br><span class="token keyword">const</span> addToHead <span class="token operator">=</span><br>  <span class="token punctuation">(</span>event<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p><code>event</code> nutzt schließlich dessen Property <code>target</code> als Referenz auf das Objekt (hier ein Link) welches das Event ausgelöst hat.</p>
<section>
<h3 id="datensparmodus-und-langsame-verbindungen-beruecksichtigen"><a class="header-anchor" href="#datensparmodus-und-langsame-verbindungen-beruecksichtigen">Datensparmodus und langsame Verbindungen berücksichtigen</a></h3>
<p>Um zu prüfen, ob entweder ein Datensparmodus aktiv oder die Verbindung zu langsam ist reichen diese beiden Bedingungen:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">/* TypeScript */</span><br><span class="token keyword">const</span> addToHead <span class="token operator">=</span><br>  <span class="token punctuation">(</span>event<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> Error <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> connection <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span><br>      <span class="token comment">/**<br>       * Check if a data saver is running<br>       */</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span>saveData<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Prefetch is not available when using Data Saver'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">/**<br>       * Check for slow connections, don't<br>       * prefetch on 2g or slower.<br>       * effectiveType can be: slow-2g, 2g, 3g, or 4g<br>       */</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'2g'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Prefetch is not available on slow connections'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Allerdings besitzt nicht jeder Browser Informationen über dessen Verbindungstyp so dass hier zuerst über <code>navigator.connection</code><br>
auf das Vorhandensein hin geprüft wird. Die hier geworfenen Fehler werden nicht verwendet oder angezeigt um nicht unnötig zu stören - es soll vor allem einfach nicht prefetched werden.</p>
<p>TypeScript wirft hier zunächst einen Fehler, da es die beiden Properties <code>saveData</code> und <code>effectiveType</code> nicht kennt. Um das zu beheben, habe ich das entsprechende Interface erweitert:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">/* TypeScript */</span><br><span class="token keyword">export</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">declare</span> global <span class="token punctuation">{</span><br>  <span class="token keyword">interface</span> <span class="token class-name">NetworkInformation</span> <span class="token punctuation">{</span><br>    saveData<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span><br>    effectiveType<span class="token operator">:</span> <span class="token string">'slow-2g'</span> <span class="token operator">|</span> <span class="token string">'2g'</span> <span class="token operator">|</span> <span class="token string">'3g'</span> <span class="token operator">|</span> <span class="token string">'4g'</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
</section>
<section>
<h3 id="links-prefetchen-1"><a class="header-anchor" href="#links-prefetchen-1">Links prefetchen</a></h3>
<p>Das eigentliche Prefetching ist unspektakulär. Es wird ein Link-Element erzeugt, dessen <code>href</code>- auf einen Link<br>
und das <code>rel</code>-Attribut auf <code>prefetch</code> gesetzt und schließlich zum <code>&lt;head&gt;</code> hinzugefügt:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> addToHead <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> Error <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// (...) previous code</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>HTMLAnchorElement<span class="token operator">></span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span><br>    link<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">'prefetch'</span><span class="token punctuation">;</span><br><br>    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</section>
</section>
<section>
<h2 id="eine-interaktion-pro-link"><a class="header-anchor" href="#eine-interaktion-pro-link">Eine Interaktion pro Link</a></h2>
<p>Um unnötige Netzwerkanfragen zu vermeiden, soll nur eine Interaktion pro Link das Prefetching auslösen.<br>
Wurde ein Link beispielsweise mit der Tastatur fokussiert, soll ein Hovern mit der Maus keinen weiteren Vorgang auslösen.<br>
Ein Event an sich nur ein einziges Mal auslösen ist einfach:</p>
<pre class="language-javascript"><code class="language-javascript">element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><br>  <span class="token string">'click'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span> <span class="token literal-property property">once</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Pro Element nur ein einziges Event auszulösen ist etwas komplizierter.<br>
Vorbereitend wird wieder eine leere Funktion erstellt. Diese erwartet einen Link und ein Array an Events - hier vorbelegt mit <code>mouseover</code> und <code>focus</code>.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">/* TypeScript */</span><br><span class="token keyword">export</span> <span class="token keyword">const</span> addPrefetchLink <span class="token operator">=</span> <span class="token punctuation">(</span><br>  link<span class="token operator">:</span> HTMLAnchorElement<span class="token punctuation">,</span><br>  userEvents<span class="token operator">:</span> ReadonlyArray<span class="token operator">&lt;</span><span class="token keyword">keyof</span> HTMLElementEventMap<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token string">'mouseover'</span><span class="token punctuation">,</span><br>    <span class="token string">'focus'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre>
<p>Der Rest des Codes wird in zwei Teile unterteilt, einen der EventListener entfernt und das hinzufügen zum <code>&lt;head&gt;</code> übernimmt und einen welcher EventListener hinzufügt.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">/* TypeScript */</span><br><span class="token keyword">export</span> <span class="token keyword">const</span> addPrefetchLink <span class="token operator">=</span> <span class="token punctuation">(</span><br>  link<span class="token operator">:</span> HTMLAnchorElement<span class="token punctuation">,</span><br>  userEvents<span class="token operator">:</span> ReadonlyArray<span class="token operator">&lt;</span><span class="token keyword">keyof</span> HTMLElementEventMap<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token string">'mouseover'</span><span class="token punctuation">,</span><br>    <span class="token string">'focus'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> Event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// Remove listeners</span><br>    userEvents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>userEvent<span class="token punctuation">)</span> <span class="token operator">=></span><br>      link<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>userEvent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">addToHead</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Register listeners</span><br>  userEvents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>userEvent<span class="token punctuation">)</span> <span class="token operator">=></span><br>    link<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>userEvent<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Die hier als <code>handler</code> benannte Funktion entfernt zunächst alle auf einen Link gebundenen Events und fügt dann den Link via <code>addToHead</code> hinzu. Fertig! Wobei da eine Sache noch bleibt: sollte ein Link öfters vorhanden sein, wird dieser dennoch ein weiteres mal hinzugefügt. Lösen könnte man das wohl mit einem <code>Set</code> - das kommt (vielleicht) in einem Update.</p>
</section>
<section>
<h2 id="fazit"><a class="header-anchor" href="#fazit">Fazit</a></h2>
<p>Neben der Herausforderung keine unnötigen Netzwerkanfragen auszulösen, war das Ganze<br>
auch ein erster erfolgreicher Versuch ein NPM-Modul zu schreiben und zu veröffentlichen.<br>
Wichtige Felder die zur Veröffentlichung benötigt werden, sind: <code>main</code>, <code>type</code> sowie <code>files</code> in der package.json.<br>
Weitere Details zum Projekt auf Github.<br>
Da es mein erstes NPM-Modul ist, freue ich mich natürlich besonders über Feedback <a class="text-link" target="_blank" rel="noopener noreferrer" href="mailto:tony.spegel@gmail.com" title="E-Mail schreiben">tony.spegel@gmail.com</a></p>
</section>

      </main>

      
        <aside>
          <toc-observer observeParent>
            <div slot="toc">
              <nav class="toc">
                <ol>
                    
                    <li><a href="#anforderungen">Anforderungen</a>
            		</li>

                    <li><a href="#die-richtigen-links-selektieren">Die richtigen Links selektieren</a>
            		</li>

                    <li><a href="#links-prefetchen">Links prefetchen</a>
            
                <ol>
                    
                    <li><a href="#datensparmodus-und-langsame-verbindungen-beruecksichtigen">Datensparmodus und langsame Verbindungen berücksichtigen</a>
            		</li>

                    <li><a href="#links-prefetchen-1">Links prefetchen</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#eine-interaktion-pro-link">Eine Interaktion pro Link</a>
            		</li>

                    <li><a href="#fazit">Fazit</a>
            		</li>
                </ol>
            </nav>
            </div>
          </toc-observer>
        </aside>
      
    </div>

    
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator
        .serviceWorker
        .register('/sw.js');
    }
  </script>


    <footer>
  <span id="copyright">
    © Tony Spegel
    2023
  </span>
  <ul class="footer-links">
    
      <li>
        <a href="/impressum/">Impressum</a>
      </li>
    
      <li>
        <a href="/datenschutzerklaerung/">Datenschutzerklärung</a>
      </li>
    
      <li>
        <a href="/barrierefreiheit/">Barrierefreiheit</a>
      </li>
    
  </ul>
</footer>

  </body>
</html>
